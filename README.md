# iwasbored
            #First Installation
with some extra.
chmod +x /root/start.sh. 
sudo bash /root/start.sh.    || 
any other path script is saved.
# MTProto Proxy Whitelist Installer

This script automates the installation and management of an MTProto Telegram Proxy whitelist system protected by NGINX and PHP. It sets up a secure and fast reverse proxy environment to avoid detection by firewalls like the Great Firewall (GFW).

---

## Features

- Installs **NGINX** with stream module support for TCP proxying
- Installs **PHP-FPM** to run PHP scripts for whitelist management
- Uses **Certbot** to obtain free SSL certificates and enable HTTPS
- Implements an IP whitelist for the MTProto proxy via NGINX stream config
- Provides a **password-protected web interface** to:
  - Add IPs to the whitelist using **one-time or 5-minute tokens**
  - Prevent unauthorized access to the whitelist management
- Automatically configures permissions for all relevant files
- Includes an uninstall option to cleanly remove everything

---

## How It Works

### 1. NGINX Stream Proxy

- MTProto proxy listens on a configured port (e.g., `4433`)
- NGINX listens on another port (e.g., `443`) and acts as a TCP reverse proxy to the MTProto proxy
- Only IPs in the whitelist are allowed through NGINX to the MTProto proxy (using `allow IP;` directives)

### 2. Whitelist File

- `/etc/nginx/whitelist.txt` contains all allowed IP addresses in NGINX format:

  ```
  allow 1.2.3.4;
  allow 5.6.7.8;
  ```

- NGINX stream config includes this file to permit only whitelisted IPs

### 3. Whitelist Management Web Interface (`post.php`)

- Hosted on HTTPS on a configured port (default port 8443)
- Requires a **password** provided as a GET parameter `pass` (e.g., `?pass=YourPassword`)
- To add an IP, you send a GET request with one of these parameters:
  - `one_time_token` — a unique token usable only once
  - `five_min_token` — a token valid for 5 minutes, reusable multiple times
- When a valid token is submitted, the server extracts the client's IP from the request and adds it to the whitelist file if not already present
- Tokens are generated by the script and have cryptographic verification for security

### 4. Tokens

- Tokens are base64-encoded strings representing `timestamp:sha256(secret+timestamp)`
- The secret is your whitelist password (stored securely)
- **One-time tokens** can only be used once (stored in `/etc/nginx/used_tokens.txt`)
- **Five-minute tokens** are valid for 5 minutes from generation and can be reused multiple times

### 5. Final Flow

- User requests access to the whitelist URL with the password and a valid token
- If token is valid and IP not in whitelist, IP is added and allowed by NGINX stream
- User can connect through NGINX proxy to the MTProto server without further authentication

---

## Usage

### Installation

Run the script and choose option `1` to install everything:

- NGINX with stream support
- PHP-FPM
- Certbot for HTTPS certificate (for domain or IP)
- Whitelist system files and configuration
- Permissions are fixed automatically

### Generate Access URLs and Tokens

Choose option `2` in the script menu. It will print:

- One-time token URL (use once)
- 5-minute token URL (use multiple times within 5 minutes)

Example:

```
https://yourdomain:8443/post.php?pass=YourPassword&one_time_token=BASE64TOKEN
https://yourdomain:8443/post.php?pass=YourPassword&five_min_token=BASE64TOKEN
```

Use these URLs to add your client IP to the whitelist.

### Fix Permissions

If needed, run option `3` to fix file permissions for PHP and NGINX access.

### Uninstall

Choose option `4` to remove all installed components, configuration files, and stop NGINX.

---

## Configuration

- Password is stored in `/etc/nginx/.password`
- Whitelist file is `/etc/nginx/whitelist.txt`
- Used tokens are tracked in `/etc/nginx/used_tokens.txt`
- PHP script is `/var/www/html/post.php`
- NGINX stream config is `/etc/nginx/stream.d/mtproto.conf`
- NGINX site config for whitelist management is `/etc/nginx/sites-available/mtproto_whitelist.conf`

---

## Security Notes

- Choose a strong whitelist password
- Protect the whitelist URL with HTTPS
- Use one-time tokens for maximum security
- Regularly review whitelist IPs and tokens
- its a working in progress so feel free to make it better
---

## Troubleshooting

- Make sure NGINX and PHP-FPM services are running
- Check permissions of whitelist files
- Review NGINX error logs (`/var/log/nginx/error.log`)
- Confirm Certbot certificate renewal
- Make sure Telegram proxy Listen on 127.0.0.1 insted of just 0.0.0.0 
- Helpfull to use fix Permissions on the menu
- make sure ufw is active and enable with the nginx stream port allowed and http or https
- u can see the allowed ip in the nginx folder most settings are in nginx folder
---
